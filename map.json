{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 980,
  "height": 520,
  "title": {"text": "CO₂ Emissions per Capita (2023)", "anchor": "start", "fontSize": 18},
  "projection": {"type": "equirectangular"},
  "config": { "legend": {"orient": "right", "gradientLength": 160}, "view": {"stroke": null} },
  "layer": [
    { "data": {"sphere": true}, "mark": {"type": "geoshape", "fill": "#eef3f9"} },
    { "data": {"graticule": {"step": [30, 30]}}, "mark": {"type": "geoshape", "fill": null, "stroke": "#d9d9d9", "strokeWidth": 0.5} },

    { "data": {
        "url": "ne_110m_admin_0_countries.json",
        "format": {"type": "topojson", "feature": "ne_110m_admin_0_countries"}
      },
      "mark": {"type": "geoshape", "fill": "#f7f7f7", "stroke": "#ffffff", "strokeWidth": 0.5}
    },

    { "data": {
        "url": "ne_110m_admin_0_countries.json",
        "format": {"type": "topojson", "feature": "ne_110m_admin_0_countries"}
      },
      "transform": [
        { "calculate": "datum.properties && datum.properties.ISO_A3_EH ? datum.properties.ISO_A3_EH : (datum.properties && datum.properties.ISO_A3 ? datum.properties.ISO_A3 : datum.id)", "as": "iso3_from_map" },
        {
          "lookup": "iso3_from_map",
          "from": {
            "data": {"url": "co2_emissions.csv"},
            "key": "iso_code",
            "fields": ["Country", "Year", "co2_per_capita"]
          }
        },
        { "calculate": "toNumber(datum.Year)", "as": "YearNum" },
        { "filter": "datum.YearNum == 2023" },
        { "calculate": "toNumber(datum.co2_per_capita)", "as": "co2pc" }
      ],
      "mark": {"type": "geoshape", "stroke": "#ffffff", "strokeWidth": 0.5},
      "encoding": {
        "color": {
          "field": "co2pc",
          "type": "quantitative",
          "title": "Tonnes CO₂ per person",
          "scale": { "scheme": "reds", "unknown": "#e6e6e6" }   
        },
        "tooltip": [
          {"field": "Country", "title": "Country"},
          {"field": "co2pc", "type": "quantitative", "title": "Tonnes CO₂ per person", "format": ".2f"},
          {"field": "YearNum", "type": "quantitative", "title": "Year"}
        ]
      }
    }
  ]
}
